@model PhoneStore.Models.ViewModels.AdminOrdersViewModel
@using PhoneStore.Extensions

@{
    ViewData["Title"] = $"تفاصيل الطلب #{Model.Order.Id}";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var culture = new System.Globalization.CultureInfo("ar-JO");

    decimal subTotal = Model.Order.OrderDetails.Sum(od => od.UnitPrice * od.Quantity);
    decimal deliveryFee = Model.Order.DeliveryLocation?.DeliveryFee ?? 0;
}

<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold text-dark mb-1">تفاصيل الطلب <span class="text-primary">#@Model.Order.Id</span></h4>
            <span class="text-muted small">تاريخ الطلب: @Model.Order.OrderDate.ToString("dd/MM/yyyy hh:mm tt")</span>
        </div>
        <div class="d-flex gap-2">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-right me-2"></i> العودة
            </a>
            <a asp-action="PrintInvoice" asp-route-id="@Model.Order.Id" target="_blank" class="btn btn-primary">
                <i class="fas fa-print me-2"></i> طباعة الفاتورة
            </a>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-shopping-basket me-2 text-primary"></i> المنتجات المطلوبة</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4 py-3">المنتج</th>
                                    <th class="text-center">السعر</th>
                                    <th class="text-center">الكمية</th>
                                    <th class="text-end pe-4">الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Order.OrderDetails)
                                {
                                    <tr>
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0">
                                                    <img src="@(string.IsNullOrEmpty(item.Product.ImageUrl) ? "https://placehold.co/60x60/EEE/513061?text=Img" : item.Product.ImageUrl)"
                                                         alt="@item.Product.Name"
                                                         class="rounded-3 border"
                                                         style="width: 50px; height: 50px; object-fit: cover;">
                                                </div>
                                                <div class="flex-grow-1 ms-3">
                                                    <h6 class="mb-0 fw-semibold text-dark">@item.Product.Name</h6>
                                                    <small class="text-muted d-block">@item.Product.Company?.Name</small>
                                                    @if (!string.IsNullOrEmpty(item.SelectedColor) || !string.IsNullOrEmpty(item.SelectedType))
                                                    {
                                                        <span class="badge bg-light text-dark border mt-1">
                                                            @(item.SelectedColor) @(!string.IsNullOrEmpty(item.SelectedType) ? $"- {item.SelectedType}" : "")
                                                        </span>
                                                    }
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center">@item.UnitPrice.ToString("C", culture)</td>
                                        <td class="text-center"><span class="badge bg-light text-dark border px-3">@item.Quantity</span></td>
                                        <td class="text-end pe-4 fw-bold">@((item.UnitPrice * item.Quantity).ToString("C", culture))</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="bg-light border-top">
                                <tr>
                                    <td colspan="3" class="text-end border-0 py-2 text-muted">المجموع الفرعي:</td>
                                    <td class="text-end border-0 pe-4 fw-bold">@subTotal.ToString("C", culture)</td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-end border-0 py-2 text-muted">
                                        رسوم التوصيل (@Model.Order.DeliveryLocation.LocationName):
                                    </td>
                                    <td class="text-end border-0 pe-4 text-success">+ @deliveryFee.ToString("C", culture)</td>
                                </tr>
                                <tr class="border-top">
                                    <td colspan="3" class="text-end py-3 fs-5 fw-bold text-dark">الإجمالي الكلي:</td>
                                    <td class="text-end pe-4 py-3 fs-5 fw-bold text-primary">@Model.Order.TotalAmount.ToString("C", culture)</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="d-flex flex-column gap-4">

                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-tasks me-2 text-primary"></i> حالة الطلب</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-4 text-center">
                            <span class="badge rounded-pill px-4 py-2 fs-6 @GetStatusBadgeClass(Model.Order.Status)">
                                @Model.Order.Status.GetDisplayName()
                            </span>
                        </div>

                        <form asp-action="UpdateStatus" method="post">
                            <input type="hidden" name="id" value="@Model.Order.Id" />
                            <label class="form-label small fw-bold text-muted">تحديث الحالة</label>
                            <div class="input-group">
                                <select name="status" class="form-select" asp-items="Model.StatusList"></select>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-user-circle me-2 text-primary"></i> بيانات العميل</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="avatar bg-light rounded-circle p-2 text-primary me-3">
                                <i class="fas fa-user fa-lg"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">الاسم</small>
                                <span class="fw-bold text-dark">@Model.Order.CustomerName</span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <div class="avatar bg-light rounded-circle p-2 text-primary me-3">
                                <i class="fas fa-phone fa-lg"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">الهاتف</small>
                                <a href="tel:@Model.Order.PhoneNumber" class="text-decoration-none fw-bold text-dark">@Model.Order.PhoneNumber</a>
                            </div>
                        </div>
                        <div class="d-flex align-items-start">
                            <div class="avatar bg-light rounded-circle p-2 text-primary me-3 mt-1">
                                <i class="fas fa-map-marker-alt fa-lg"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">عنوان التوصيل</small>
                                <span class="fw-bold text-dark d-block">@Model.Order.DeliveryLocation.LocationName</span>
                                <span class="text-muted small">@Model.Order.Address</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-credit-card me-2 text-primary"></i> معلومات الدفع</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">طريقة الدفع:</span>
                            <span class="fw-bold text-dark">@Model.Order.PaymentMethod.GetDisplayName()</span>
                        </div>
                        @if (Model.Order.PaymentMethod == PhoneStore.Models.PaymentMethod.CliQ)
                        {
                            <div class="alert alert-info bg-light border-0 d-flex align-items-center mt-3 mb-0 p-2">
                                <i class="fas fa-info-circle me-2 text-primary"></i>
                                <small class="text-dark">تأكد من استلام الحوالة قبل تغيير الحالة إلى "مكتمل".</small>
                            </div>
                        }
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@functions {
    string GetStatusBadgeClass(PhoneStore.Models.OrderStatus status)
    {
        return status switch
        {
            PhoneStore.Models.OrderStatus.Pending => "bg-warning text-dark",
            PhoneStore.Models.OrderStatus.Processing => "bg-info text-dark",
            PhoneStore.Models.OrderStatus.Shipped => "bg-primary",
            PhoneStore.Models.OrderStatus.Completed => "bg-success",
            PhoneStore.Models.OrderStatus.Cancelled => "bg-danger",
            _ => "bg-secondary"
        };
    }
}